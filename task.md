# Sprout Specification

This document defines the **Sprout** package and environment manager:
its **directory structure**, **DSL grammar**, **lockfile format**, and **operational rules**.
It is designed for **userspace-only builds** (no system package managers) and **deterministic environments**.

---

## 1. Directory Layout

Sprout manages all state under a single root, typically `/sprout/`:

```
/sprout/
├── manifest.sprout     # Human-edited configuration (modules + environments)
├── sprout.lock         # Auto-generated cache state (hashes only)
├── symlinks/           # Dotfiles/configs managed as symlinks
├── cache/
│   └── archives/       # Downloaded archives (tar, zip, gz)
├── sources/            # Source trees (cloned repos or extracted archives)
│   ├── git/
│   └── http/
├── dist/               # Built outputs per module (/dist/<module>/...)
└── .git/               # Optional for syncing Sprout itself
```

---

## 2. Manifest DSL (`manifest.sprout`)

The manifest is written in a simple **HCL-like syntax**.
It has two kinds of top-level blocks:
- `module name { ... }` – defines a dependency (no version suffix).
- `environments { ... }` – defines named sets of modules.
- *(No symlink tracking here — symlinks are implicit via `/sprout/symlinks/`.)*

**Note**: Comments in `.sprout` files start with `#`. However, Sprout may reformat the manifest when adding/removing modules, which will remove comments. Keep important documentation in a separate README or inline in build scripts.

### 2.1 Module Block

Each module specifies:
- `depends_on` – list of other modules (by name only, no version).
- `exports` – environment variables to expose when active.
- `fetch` – how to retrieve the source (git, http, or local).
- `build` – shell script to build/install.
- Each script block may define `env { ... }` for phase-specific variables.

Example:
```
module clang {
    depends_on = [gcc]
    exports = {
        PATH = "/bin"
    }

    fetch {
        git = {
            url = https://github.com/llvm/llvm-project.git
            tag = llvmorg-20.1.7
        }
    }

    build {
        env {
            CC = "${SPROUT_DIST}/gcc/bin/gcc"
            CXX = "${SPROUT_DIST}/gcc/bin/g++"
        }
        mkdir -p build
        cd build
        cmake -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" \
              -DCMAKE_BUILD_TYPE=Release \
              -G "Unix Makefiles" ../llvm \
              -DCMAKE_INSTALL_PREFIX=${DIST_PATH}
        make -j8
        make install
    }
}
```

### 2.2 Environments Block

Defines reusable sets of modules:

```
environments {
    dev = [
        ripgrep,
        tmux,
        neovim
    ]

    modern = [
        gcc,
        clang,
        cmake
    ]
}
```

---

## 3. Grammar (EBNF)

```ebnf
SproutManifest ::= { Statement } ;

Statement ::= ModuleBlock | EnvironmentsBlock ;

ModuleBlock ::= "module" Identifier "{" { ModuleField } "}" ;

ModuleField ::= "depends_on" "=" Array
              | "exports" "=" Map
              | FetchBlock
              | BuildBlock ;

FetchBlock ::= "fetch" "{" FetchSpec "}" ;
FetchSpec  ::= "git" "=" GitSpec
             | "http" "=" HttpSpec
             | "local" "=" LocalSpec ;

GitSpec     ::= "{" "url" "=" Value ["," "tag" "=" Value] ["," "commit" "=" Value] "}" ;
HttpSpec    ::= "{" "url" "=" Value ["," "sha256" "=" Value] "}" ;
LocalSpec   ::= "{" "path" "=" Value "}" ;

BuildBlock   ::= "build" "{" [EnvBlock] ScriptBlock "}" ;

EnvBlock ::= "env" "{" { EnvEntry } "}" ;
EnvEntry ::= Identifier "=" String ;

ScriptBlock ::= { CommandLine } ;
CommandLine ::= (any line of shell script) ;

EnvironmentsBlock ::= "environments" "{" { EnvironmentEntry } "}" ;
EnvironmentEntry  ::= Identifier "=" Array ;

Array ::= "[" [Value {"," Value}] "]" ;
Map   ::= "{" { Identifier "=" String } "}" ;

Value      ::= String | UnquotedValue ;
String     ::= "\"" { Character } "\"" ;
UnquotedValue ::= (any non-whitespace, non-delimiter characters) ;
Identifier ::= Letter { Letter | Digit | "_" | "-" } ;
```

---

## 4. Lockfile (`sprout.lock`)

Sprout's lockfile is **purely for state tracking** —
no duplication of source URLs or dependency graphs, just hashes.

Format:

```toml
# Auto-generated by Sprout — do not edit

[modules]
clang = "9e7f1d23a4abf901"
gcc = "2c11ad64e98f5a20"
ripgrep = "8d7b991e5c1a4320"
# ... all modules

[symlinks]
".zshrc" = "3e843e79be4ed01ed602344f034732214dcee563127e084ed6e357d9f622e111"
".tmux.conf" = "1d0431df73c6540d8317b1f07c7f04400c90c30f30d26e78eb22f42ab5e70256"
".config/nvim" = "7cde1a1294e6d82bba227dd1575abf00c5e24ce9a1947db70a40b55ebc741195"
# ... all symlinks under /sprout/symlinks
```

---

## 5. Hash Calculation

* For each module:

  ```
  build_hash = SHA256(
      fetch spec (url, commit or sha256)
    + build script text
    + env vars (build)
    + concat(dep.build_hash for dep in depends_on)
  )
  ```
* For each symlink:

  ```
  symlink_hash = SHA256(file contents)
  ```

Sprout compares these to `sprout.lock`.
If they differ, Sprout **rebuilds the module** or **rehashes the symlink**.

---

## 6. CLI Essentials

* **Adding dependencies:**

  ```bash
  sprout modules add https://github.com/neovim/neovim.git
  sprout modules add https://ziglang.org/download/0.14.1/zig-x86_64-linux-0.14.1.tar.xz --name zig
  sprout modules add /local/path/to/project --method local
  ```

* **Fetching and building:**

  ```bash
  sprout modules fetch
  sprout modules build --all
  sprout modules build clang --rebuild
  ```

* **Managing environments:**

  ```bash
  eval "$(sprout env)"                    # Load default environment
  eval "$(sprout env generate dev)"       # Load dev environment
  eval "$(sprout env generate --all)"     # Load all built modules
  ```

* **Managing symlinks:**

  ```bash
  sprout add ~/.bashrc
  sprout add --recursive ~/.config/nvim
  sprout status
  sprout restore
  sprout rehash
  sprout undo ~/.bashrc
  ```

---

## 7. Behavior Summary

1. `manifest.sprout` is **human-managed** (modules + environments).
2. `sprout.lock` is **machine-managed** (hashes for build cache + symlink state).
3. `/sprout/symlinks` is the **source of truth** for dotfiles — the lock just tracks their hashes.
4. Sprout decides whether to rebuild or restore by comparing computed hashes to the lock.
5. Standardized outputs live in `/sprout/dist/<module>/`.
6. Only three fetch methods are supported: **git**, **http**, and **local**.
7. Modules are identified by name only (no version suffix in dependencies).

---
